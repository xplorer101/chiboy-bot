<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIBOY BOT - Market Analysis</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-card-hover: #1c2128;
            --border-color: #30363d;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-gold: #f0b429;
            --accent-purple: #a371f7;
        }
        
        /* Light Theme */
        body.light-theme {
            --bg-dark: #f5f7fa;
            --bg-card: #ffffff;
            --bg-card-hover: #f0f2f5;
            --border-color: #d0d7de;
        }
        
        body.light-theme .card {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        body.light-theme .table {
            --bs-table-bg: var(--bg-card);
            --bs-table-color: var(--text-primary);
            --bs-table-border-color: var(--border-color);
        }
        
        * { box-sizing: border-box; }
        
        body {
            background-color: var(--bg-dark);
            color: #ffffff;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding-left: 80px;
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }
        
        .main-content { padding-bottom: 80px; }
        
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        
        .card-header {
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .symbol-select {
            background: var(--bg-card-hover);
            color: #fff;
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            font-size: 1rem;
            width: 100%;
        }
        
        .overall-market {
            text-align: center;
            padding: 2rem;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255,255,255,0.05) 100%);
            border: 2px solid var(--accent-gold);
        }
        
        .overall-label {
            font-size: 0.9rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .overall-direction {
            font-size: 3rem;
            font-weight: 700;
            margin: 1rem 0;
            color: #8b949e;
        }
        
        .overall-direction.bullish { color: var(--accent-green); }
        .overall-direction.bearish { color: var(--accent-red); }
        .overall-direction.ranging { color: var(--accent-purple); }
        
        .trend-card {
            background: var(--bg-card-hover);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
        }
        
        .trend-card.bullish { border-color: var(--accent-green); }
        .trend-card.bearish { border-color: var(--accent-red); }
        .trend-card.ranging { border-color: var(--accent-purple); }
        
        .trend-timeframe {
            font-size: 0.8rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .trend-direction {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .trend-direction.bullish { color: var(--accent-green); }
        .trend-direction.bearish { color: var(--accent-red); }
        .trend-direction.ranging { color: var(--accent-purple); }
        
        .trend-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            color: #ffffff;
            margin-top: 0.5rem;
        }
        
        .signal-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(63, 185, 80, 0.1) 100%);
            border: 2px solid var(--accent-green);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .signal-card.no-signal {
            background: var(--bg-card-hover);
            border-color: var(--border-color);
        }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .signal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-gold);
        }
        
        .direction-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .direction-long { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .direction-short { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        
        .signal-prices {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .signal-price {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .signal-price-label {
            font-size: 0.7rem;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .signal-price-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .signal-price-value.entry { color: var(--accent-gold); }
        .signal-price-value.sl { color: var(--accent-red); }
        .signal-price-value.tp { color: var(--accent-green); }
        
        .signal-reasons {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #c9d1d9;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #8b949e;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold), #d4a029);
            border: none;
            color: #000;
            font-weight: 600;
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            body { padding-left: 0; padding-bottom: 60px; }
            
            
        }
        
        
        
        .mobile-bottom-nav a {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.5rem;
            font-size: 0.7rem;
            border-radius: 8px;
        }
        
        .mobile-bottom-nav a.active { color: var(--accent-gold); }
        .mobile-bottom-nav a i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.5rem;
            font-size: 0.7rem;
            flex: 1;
        }
        
        .bottom-nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; display: block; }
        .bottom-nav-item span { display: block; }
        .bottom-nav-item.active { color: var(--accent-gold); }
        .bottom-nav-item:hover { background: rgba(255,255,255,0.05); }
        
        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card-hover);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .notification-toggle .toggle-switch {
            width: 40px;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: background 0.3s;
        }
        
        .notification-toggle .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        
        .notification-toggle.active .toggle-switch {
            background: var(--accent-green);
        }
        
        .notification-toggle.active .toggle-switch::after {
            transform: translateX(20px);
        }
    
        .side-nav { position: fixed; left: 0; top: 0; bottom: 0; width: 70px; background: var(--bg-card); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding: 1rem 0; z-index: 1000; }
        .side-brand { font-size: 1.5rem; color: var(--accent-gold); margin-bottom: 2rem; }
        .side-links { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; }
        .side-link { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); text-decoration: none; padding: 0.75rem 0.5rem; border-radius: 8px; font-size: 0.65rem; width: 60px; }
        .side-link i { font-size: 1.3rem; margin-bottom: 0.25rem; }
        .side-link:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .side-link.active { background: var(--accent-gold); color: #000; }
        body { padding-left: 70px; }

    </style>
</head>
<body>

    <nav class="side-nav">
        <div class="side-brand"><i class="fas fa-chart-line"></i></div>
        <div class="side-links">
            <a href="/" class="side-link"><i class="fas fa-home"></i>Home</a>
            <a href="/opportunities" class="side-link"><i class="fas fa-bullseye"></i>Opps</a>
            <a href="/analysis" class="side-link"><i class="fas fa-search"></i>Analysis</a>
            <a href="/sentiment" class="side-link"><i class="fas fa-fire"></i>Sentiment</a>
            <a href="/trades" class="side-link"><i class="fas fa-history"></i>Trades</a>
        </div>
    </nav>
    <!-- Sidebar -->

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <span style="color: #fff; font-weight: 600;">Market Analysis</span>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="notification-toggle" id="notifToggle" onclick="toggleNotifications()">
                    <i class="fas fa-bell" id="notifIcon" style="color: #8b949e;"></i>
                    <div class="toggle-switch" id="notifSwitch"></div>
                </div>
                <button id="refreshBtn" onclick="analyzeSymbol(currentSymbol)" style="background: var(--bg-card-hover); border: 1px solid var(--border-color); color: #fff; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i>
                </button>
            </div>
        </div>

        <div class="container-fluid px-4 py-4">
            <!-- Symbol Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-crosshairs me-2"></i>Select Symbol
                </div>
                <div class="card-body">
                    <select id="symbolSelect" class="symbol-select" onchange="analyzeSymbol(this.value)">
                        <option value="EUR_USD">EUR/USD</option>
                        <option value="GBP_USD" selected>GBP/USD</option>
                        <option value="USD_JPY">USD/JPY</option>
                        <option value="USD_CHF">USD/CHF</option>
                        <option value="AUD_USD">AUD/USD</option>
                        <option value="USD_CAD">USD/CAD</option>
                        <option value="EUR_GBP">EUR/GBP</option>
                        <option value="EUR_JPY">EUR/JPY</option>
                        <option value="GBP_JPY">GBP/JPY</option>
                        <option value="XAUUSD">XAU/USD (Gold)</option>
                        <option value="NAS100">NAS100 (Nasdaq)</option>
                        <option value="SPX500">SPX500 (S&P)</option>
                        <option value="US30">US30 (Dow)</option>
                        <option value="USOIL">USOIL (Crude)</option>
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                    </select>
                </div>
            </div>

            <!-- Overall Market -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="overall-market">
                        <div class="overall-label">Overall Market Direction</div>
                        <div class="overall-direction" id="overallDirection">Loading...</div>
                        <div style="display: flex; justify-content: space-around; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; color: #3fb950;">BID</div>
                                <div id="bidPrice" style="font-size: 1.4rem; font-weight: 700; color: #3fb950;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9rem; color: #8b949e;">Current Price</div>
                                <div id="overallPrice" style="font-size: 1.8rem; font-weight: 700; color: #f0b429;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; color: #f85149;">ASK</div>
                                <div id="askPrice" style="font-size: 1.4rem; font-weight: 700; color: #f85149;">--</div>
                            </div>
                        </div>
                        <div id="lastUpdate" style="font-size: 0.75rem; color: #8b949e; text-align: center; margin-top: 0.5rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Signal Container -->
            <div id="signalBody"></div>

            <!-- Timeframe Analysis -->
            <div class="row g-3 mb-4">
                <div class="col-6 col-lg-3">
                    <div class="trend-card" id="card-1H">
                        <div class="trend-timeframe">1 Hour</div>
                        <div class="trend-price" id="price-1H">--</div>
                        <div class="trend-direction" id="tf-1H">--</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="trend-card" id="card-4H">
                        <div class="trend-timeframe">4 Hours</div>
                        <div class="trend-price" id="price-4H">--</div>
                        <div class="trend-direction" id="tf-4H">--</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="trend-card" id="card-1D">
                        <div class="trend-timeframe">Daily</div>
                        <div class="trend-price" id="price-1D">--</div>
                        <div class="trend-direction" id="tf-1D">--</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="trend-card" id="card-1W">
                        <div class="trend-timeframe">Weekly</div>
                        <div class="trend-price" id="price-1W">--</div>
                        <div class="trend-direction" id="tf-1W">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSymbol = 'GBP_USD';
        let notificationsEnabled = false;

        // Request notification permission on page load
        async function initNotifications() {
            // Load saved preference from server (optional endpoint)
            try {
                const response = await fetch('/api/notifications/preferences');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.preferences.enabled) {
                        notificationsEnabled = true;
                        updateNotificationToggle();
                    }
                }
            } catch(e) { /* Silently fail - notifications are optional */ }
            
            // Request browser permission if not granted/denied
            if ('Notification' in window && Notification.permission === 'default') {
                // Don't auto-request, wait for user to click toggle
            }
        }

        function updateNotificationToggle() {
            const toggle = document.getElementById('notifToggle');
            const icon = document.getElementById('notifIcon');
            if (notificationsEnabled) {
                toggle.classList.add('active');
                icon.style.color = '#3fb950';
            } else {
                toggle.classList.remove('active');
                icon.style.color = '#8b949e';
            }
        }

        async function toggleNotifications() {
            const toggle = document.getElementById('notifToggle');
            
            if (!notificationsEnabled) {
                // Request permission
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        updateNotificationToggle();
                        showNotification('Notifications Enabled', 'You will receive alerts for new trade signals!');
                    } else {
                        alert('Please enable notifications in your browser settings');
                        return;
                    }
                } else {
                    alert('This browser does not support notifications');
                    return;
                }
            } else {
                notificationsEnabled = false;
                updateNotificationToggle();
            }
            
            // Save preference to server
            try {
                await fetch('/api/notifications/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: notificationsEnabled,
                        symbols: [currentSymbol],
                        sound: true
                    })
                });
            } catch(e) { console.log('Could not save notification prefs'); }
        }

        function showNotification(title, body, icon = 'üîî') {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: icon,
                    tag: 'chiboy-signal'
                });
            }
        }

        function notifySignal(signal) {
            if (!notificationsEnabled || !signal) return;
            
            const direction = signal.direction === 'long' ? 'üü¢ LONG' : 'üî¥ SHORT';
            const rr = signal.risk_reward || '?';
            const body = `${direction} ${currentSymbol}\nEntry: ${signal.entry_price}\nSL: ${signal.stop_loss}\nTP: ${signal.take_profit}\nR:R 1:${rr}`;
            
            showNotification('üéØ New Trade Signal!', body);
        }

        function formatPrice(price, symbol) {
            if (!price) return '--';
            // Show exact prices - no rounding
            if (symbol === 'XAUUSD' || symbol === 'XAGUSD') return price.toFixed(2);  // Metals
            if (symbol?.endsWith('USDT')) return price.toFixed(2);  // Crypto
            if (symbol?.includes('JPY')) return price.toFixed(3);  // JPY pairs
            // Forex - show full precision
            return price.toFixed(5);
        }

        let cachedMarketDirection = '';
        
        // Full analysis - updates everything including trends
        async function analyzeSymbol(symbol) {
            currentSymbol = symbol;
            const symbolSelect = document.getElementById('symbolSelect');
            if (symbolSelect) symbolSelect.value = symbol;
            
            const signalBodyEl = document.getElementById('signalBody');
            const overallDirEl = document.getElementById('overallDirection');
            const refreshIcon = document.getElementById('refreshIcon');
            
            // Add spin animation to refresh button
            if (refreshIcon) refreshIcon.classList.add('fa-spin');
            
            // Safety check - if elements don't exist, return
            if (!signalBodyEl || !overallDirEl) {
                console.log('Required elements not found');
                if (refreshIcon) refreshIcon.classList.remove('fa-spin');
                return;
            }
            
            // Show loading
            signalBodyEl.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin me-2"></i> Analyzing...</div>';
            overallDirEl.textContent = 'Loading...';
            
            try {
                const response = await fetch('/api/analyze/symbol/' + symbol + '?t=' + Date.now());
                const data = await response.json();
                
                if (!data.success) {
                    document.getElementById('signalBody').innerHTML = '<div class="loading" style="color: #f85149;">Error: ' + (data.error || 'Failed') + '</div>';
                    document.getElementById('overallDirection').textContent = 'Error - Using Default';
                    document.getElementById('overallDirection').className = 'overall-direction ranging';
                    return;
                }
                
                // Update overall market direction - force update always
                const newDirection = data.overall_market || 'Ranging';
                const dirElement = document.getElementById('overallDirection');
                dirElement.textContent = newDirection;
                dirElement.className = 'overall-direction ' + newDirection.toLowerCase();
                cachedMarketDirection = newDirection;
                
                // Update prices
                updatePrices(symbol, data.current_price);
                
                // Update timeframes (both price and trend)
                const timeframes = data.timeframes || {};
                ['1H', '4H', '1D', '1W'].forEach(tf => {
                    const tfData = timeframes[tf] || {};
                    document.getElementById('price-' + tf).textContent = formatPrice(tfData.price || 0, symbol);
                    document.getElementById('tf-' + tf).textContent = tfData.trend || '--';
                    document.getElementById('tf-' + tf).className = 'trend-direction ' + (tfData.trend || 'unknown').toLowerCase();
                    document.getElementById('card-' + tf).className = 'trend-card ' + (tfData.trend || 'unknown').toLowerCase();
                });
                
                // Show update timestamp
                const now = new Date();
                document.getElementById('lastUpdate').innerHTML = '<span style="color: #3fb950;">‚óè</span> Updated: ' + now.toLocaleTimeString();
                
                // Update signal
                const signalBody = document.getElementById('signalBody');
                const ict = data.ict || {};
                const signal = ict.signal;
                
                if (signal) {
                    // Show browser notification for new signal
                    notifySignal(signal);
                    
                    const entryPrice = ict.entry_price;
                    const sl = ict.stop_loss;
                    const tp = ict.take_profit;
                    const rr = ict.risk_reward || '3';
                    
                    // Calculate R:R
                    let riskReward = rr;
                    if (entryPrice && sl && tp) {
                        const risk = Math.abs(entryPrice - sl);
                        const reward = Math.abs(tp - entryPrice);
                        riskReward = (reward / risk).toFixed(1);
                    }
                    
                    const directionClass = signal === 'BUY' ? 'long' : 'short';
                    
                    signalBody.innerHTML = `
                        <div class="signal-card">
                            <div class="signal-header">
                                <span class="signal-title">üéØ ICT TREND CONTINUATION</span>
                                <span class="direction-badge direction-${directionClass}">
                                    <i class="fas fa-arrow-${signal === 'BUY' ? 'up' : 'down'}"></i>
                                    ${signal}
                                </span>
                            </div>
                            <div class="signal-prices">
                                <div class="signal-price">
                                    <div class="signal-price-label">Entry</div>
                                    <div class="signal-price-value entry">${entryPrice ? formatPrice(entryPrice, symbol) : '---'}</div>
                                </div>
                                <div class="signal-price">
                                    <div class="signal-price-label">Stop Loss</div>
                                    <div class="signal-price-value sl">${sl ? formatPrice(sl, symbol) : '---'}</div>
                                </div>
                                <div class="signal-price">
                                    <div class="signal-price-label">Take Profit</div>
                                    <div class="signal-price-value tp">${tp ? formatPrice(tp, symbol) : '---'}</div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-bottom: 1rem;">
                                <span style="color: #fff; font-weight: 600;">Risk:Reward 1:${riskReward}</span>
                            </div>
                            <div class="signal-reasons">
                                <strong style="color: #fff;">ICT Setup:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>üìä Market Structure Shift Detected</li>
                                    ${ict.fvgs && ict.fvgs.length > 0 ? `<li>üìà Fair Value Gap: ${ict.fvgs[0].type.toUpperCase()}</li>` : ''}
                                    ${ict.liquidity && (ict.liquidity.above || ict.liquidity.below) ? '<li>üíß Liquidity Zones Identified</li>' : ''}
                                    <li>üéØ Entry at Order Block / FVG</li>
                                </ul>
                            </div>
                            <button class="btn btn-primary mt-3" onclick="openTrade()">
                                <i class="fas fa-play me-2"></i>Execute Trade
                            </button>
                        </div>
                    `;
                } else {
                    const isRanging = data.overall_market === 'Ranging';
                    signalBody.innerHTML = `
                        <div class="signal-card no-signal">
                            <div class="text-center">
                                <i class="fas fa-${isRanging ? 'arrows-left-right' : 'pause-circle'}" style="font-size: 2rem; color: #8b949e; margin-bottom: 1rem;"></i>
                                <div style="font-size: 1.2rem; font-weight: 600; color: #fff;">
                                    ${isRanging ? 'Market is Ranging' : 'No Valid ICT Signal'}
                                </div>
                                <div style="color: #8b949e; margin-top: 0.5rem;">
                                    ${isRanging ? 'Wait for break of structure' : 'Waiting for: Liquidity Sweep ‚Üí MSS ‚Üí OB'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error(error);
                document.getElementById('signalBody').innerHTML = '<div class="loading" style="color: #f85149;">Error: ' + error.message + '</div>';
            } finally {
                // Stop spin animation
                const refreshIcon = document.getElementById('refreshIcon');
                if (refreshIcon) refreshIcon.classList.remove('fa-spin');
            }
        }

        function openTrade() {
            window.location.href = '/';
        }

        // Update only prices (for fast auto-refresh)
        async function updatePricesOnly(symbol) {
            try {
                const response = await fetch('/api/analyze/symbol/' + symbol + '?t=' + Date.now());
                const data = await response.json();
                
                if (!data.success) return;
                
                // Update prices only - keep market direction static
                updatePrices(symbol, data.current_price);
                
                // Update timeframe prices only (not trends)
                const timeframes = data.timeframes || {};
                ['1H', '4H', '1D', '1W'].forEach(tf => {
                    const tfData = timeframes[tf] || {};
                    document.getElementById('price-' + tf).textContent = formatPrice(tfData.price, symbol);
                });
                
                // Show update timestamp
                const now = new Date();
                document.getElementById('lastUpdate').innerHTML = '<span style="color: #3fb950;">‚óè</span> Live: ' + now.toLocaleTimeString();
            } catch(e) { console.error(e); }
        }
        
        function updatePrices(symbol, currentPrice) {
            if (!currentPrice) return;
            
            const overallPrice = document.getElementById('overallPrice');
            const bidPriceEl = document.getElementById('bidPrice');
            const askPriceEl = document.getElementById('askPrice');
            
            if (!overallPrice || !bidPriceEl || !askPriceEl) return;
            
            let spread = 0.0001;
            if (symbol === 'XAUUSD') spread = 0.3;
            else if (symbol.includes('JPY')) spread = 0.01;
            else if (symbol === 'BTCUSDT' || symbol === 'ETHUSDT') spread = 1;
            else spread = 0.0002;
            
            const bidPrice = currentPrice - spread;
            const askPrice = currentPrice + spread;
            
            overallPrice.textContent = formatPrice(currentPrice, symbol);
            bidPriceEl.textContent = formatPrice(bidPrice, symbol);
            askPriceEl.textContent = formatPrice(askPrice, symbol);
        }
        
        // Auto load on page load
        document.addEventListener('DOMContentLoaded', () => {
            initNotifications();
            analyzeSymbol('GBP_USD');
            // Auto-refresh prices only every 1 second (not trends)
            setInterval(() => {
                const symbol = document.getElementById('symbolSelect')?.value || 'GBP_USD';
                updatePricesOnly(symbol);
            }, 1000);
        });
        
        // Also try to load immediately in case DOMContentLoaded fired already
        setTimeout(() => {
            const dir = document.getElementById('overallDirection').textContent;
            if (dir === 'Loading...') {
                analyzeSymbol('GBP_USD');
            }
        }, 500);
    </script>
    <script>
        // Apply saved theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
            }
        })();
    </script>
</body>
</html>
