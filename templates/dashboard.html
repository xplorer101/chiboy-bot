<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d1117">
    <title>CHIBOY BOT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-card-hover: #1c2128;
            --border-color: #30363d;
            --text-primary: #ffffff;
            --text-secondary: #c9d1d9;
            --text-muted: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --accent-gold: #f0b429;
            --accent-cyan: #39d0d6;
        }
        
        /* Light Theme */
        body.light-theme {
            --bg-dark: #f5f7fa;
            --bg-card: #ffffff;
            --bg-card-hover: #f0f2f5;
            --border-color: #d0d7de;
            --text-primary: #1f2328;
            --text-secondary: #59636e;
            --text-muted: #8b949e;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #e8eaed 50%, var(--bg-dark) 100%);
        }
        
        body.light-theme .menu-bar {
            background: var(--bg-card);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        body.light-theme .hero {
            background: linear-gradient(180deg, rgba(240,180,41,0.15) 0%, transparent 100%);
        }
        
        body.light-theme .card {
            background: var(--bg-card);
            border-color: var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        body.light-theme .stat-card {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        body.light-theme input, 
        body.light-theme select, 
        body.light-theme textarea {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        body.light-theme .table {
            --bs-table-bg: var(--bg-card);
            --bs-table-color: var(--text-primary);
            --bs-table-border-color: var(--border-color);
        }
        
        body.light-theme .btn-outline-primary {
            color: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        body.light-theme .menu-link:hover {
            background: rgba(0,0,0,0.05);
        }
        
        body.light-theme .mobile-menu {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1318 50%, var(--bg-dark) 100%);
        }
        
        /* Menu Bar */
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 1000;
        }
        
        .menu-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-right: 2rem;
        }
        
        .menu-brand i {
            font-size: 1.5rem;
            color: var(--accent-gold);
        }
        
        .menu-brand span {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        .menu-nav {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }
        
        .menu-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .menu-link:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }
        
        .menu-link.active {
            background: var(--accent-gold);
            color: #000;
        }
        
        .menu-link i { font-size: 1rem; }
        
        .menu-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Main Content */
        .main { padding-top: 80px; padding-bottom: 2rem; padding-left: 1.5rem; padding-right: 1.5rem; }
        
        @media (max-width: 768px) {
            .menu-nav { display: none; }
            .menu-bar { justify-content: space-between; }
            .mobile-menu-btn { display: block; }
        }
        
        /* Mobile Menu */
        .mobile-menu { display: none; position: fixed; top: 60px; left: 0; right: 0; background: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 1rem; z-index: 999; }
        .mobile-menu.open { display: block; }
        .mobile-menu a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; color: var(--text-muted); text-decoration: none; border-radius: 8px; }
        .mobile-menu a:hover, .mobile-menu a.active { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        
        /* Hero Section */
        .hero {
            text-align: center;
            padding: 3rem 1rem;
            background: linear-gradient(180deg, rgba(240,180,41,0.1) 0%, transparent 100%);
            border-radius: 24px;
            margin-bottom: 2rem;
        }
        
        .hero-logo { font-size: 4rem; margin-bottom: 1rem; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-gold), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .hero .tagline { color: var(--text-muted); font-size: 1.1rem; margin-bottom: 1.5rem; }
        
        .hero-stats { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
        .hero-stat { text-align: center; }
        .hero-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-gold); }
        .hero-stat-label { font-size: 0.8rem; color: var(--text-muted); }
        
        /* Chart Section */
        .chart-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title { font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .chart-title i { color: var(--accent-gold); }
        
        .symbol-select {
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        #chart { width: 100%; height: 400px; }
        #rsiChart { width: 100%; height: 120px; margin-top: 10px; display: none; }
        
        .chart-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            padding: 0.25rem;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }
        
        .toolbar-btn {
            padding: 0.4rem 0.6rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .toolbar-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        
        .toolbar-btn.active {
            background: var(--accent-gold);
            color: #000;
        }
        
        .indicator-select {
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
            min-width: 120px;
        }
        
        .indicator-settings {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: var(--bg-card-hover);
            border-radius: 6px;
        }
        
        .indicator-settings input {
            width: 50px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .indicator-settings label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .indicator-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        
        .color-picker-wrapper {
            position: relative;
        }
        
        .chart-price { display: flex; align-items: baseline; gap: 0.5rem; }
        .price-main { font-size: 2rem; font-weight: 700; }
        .price-change { font-size: 1rem; font-weight: 600; }
        .price-change.up { color: var(--accent-green); }
        .price-change.down { color: var(--accent-red); }
        
        /* Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s;
        }
        
        .info-card:hover { border-color: var(--accent-gold); transform: translateY(-5px); }
        
        .info-card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        
        .info-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .info-card-icon.bot { background: linear-gradient(135deg, var(--accent-gold), #d4a020); color: #000; }
        .info-card-icon.author { background: linear-gradient(135deg, var(--accent-purple), #8b5cf6); color: #fff; }
        .info-card-icon.github { background: linear-gradient(135deg, var(--accent-blue), #3b82f6); color: #fff; }
        
        .info-card h3 { font-size: 1.2rem; margin-bottom: 0.25rem; }
        .info-card .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem; }
        .info-card p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem; }
        
        .info-card .features { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .feature-tag { background: rgba(240,180,41,0.15); color: var(--accent-gold); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        
        .social-links { display: flex; gap: 1rem; margin-top: 1rem; }
        .social-link { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-card-hover); display: flex; align-items: center; justify-content: center; color: var(--text-muted); text-decoration: none; transition: all 0.2s; }
        .social-link:hover { background: var(--accent-gold); color: #000; }
        
        /* Footer */
        .footer { text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.85rem; }
        .footer a { color: var(--accent-gold); text-decoration: none; }
    
        /* Top Menu Bar */
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 1000;
        }
        
        .menu-brand { display: flex; align-items: center; gap: 0.75rem; margin-right: 2rem; }
        .menu-brand i { font-size: 1.5rem; color: var(--accent-gold); }
        .menu-brand span { font-size: 1.25rem; font-weight: 700; color: var(--accent-gold); }
        
        .menu-nav { display: flex; gap: 0.5rem; flex: 1; }
        
        .menu-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .menu-link:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .menu-link.active { background: var(--accent-gold); color: #000; }
        
        .menu-status { display: flex; align-items: center; gap: 0.75rem; font-size: 0.8rem; color: var(--text-muted); }
        
        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: var(--accent-gold);
            border-color: var(--accent-gold);
        }
        
        body.light-theme .theme-toggle {
            background: rgba(0,0,0,0.05);
            border-color: var(--border-color);
        }
        
        body.light-theme .theme-toggle:hover {
            background: rgba(240,180,41,0.15);
            color: var(--accent-gold);
        }
        
        .live-dot { width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        body { padding-top: 60px; }

    </style>
</head>
<body>

    <!-- Top Menu Bar -->
    <nav class="menu-bar">
        <div class="menu-brand">
            <i class="fas fa-chart-line"></i>
            <span>CHIBOY</span>
        </div>
        <div class="menu-nav">
            <a href="/" class="menu-link active"><i class="fas fa-home"></i> Dashboard</a>
            <a href="/opportunities" class="menu-link"><i class="fas fa-bullseye"></i> Opportunities</a>
            <a href="/analysis" class="menu-link"><i class="fas fa-search"></i> Analysis</a>
            <a href="/sentiment" class="menu-link"><i class="fas fa-fire"></i> Sentiment</a>
            <a href="/trades" class="menu-link"><i class="fas fa-history"></i> Trades</a>
            <a href="/risk" class="menu-link"><i class="fas fa-shield-alt"></i> Risk</a>
        </div>
        <div class="menu-status">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <i class="fas fa-moon"></i>
            </button>
            <span class="live-dot"></span>
            <span>Live</span>
        </div>
    </nav>

    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" style="display:none;position:fixed;top:15px;right:15px;background:var(--bg-card);border:1px solid var(--border-color);color:#fff;padding:0.5rem;border-radius:8px;z-index:1001;">
        <i class="fas fa-bars"></i>
    </button>
    
    
    <div class="main">
        <!-- Hero -->
        <div class="hero">
            <div class="hero-logo">ðŸ“ˆ</div>
            <h1>CHIBOY BOT</h1>
            <p class="tagline">ICT Trading Strategy â€¢ Automated Analysis â€¢ Real-time Signals</p>
            <div class="hero-stats">
                <div class="hero-stat">
                    <div class="hero-stat-value">17</div>
                    <div class="hero-stat-label">Trading Pairs</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value">ICT</div>
                    <div class="hero-stat-label">Strategy</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value">1:3</div>
                    <div class="hero-stat-label">Risk:Reward</div>
                </div>
            </div>
        </div>
        
        <!-- Chart -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-chart-area"></i>
                    <span>Live Chart</span>
                </div>
                <div class="chart-price">
                    <span class="price-main" id="priceMain">---</span>
                    <span class="price-change up" id="priceChange">---</span>
                </div>
            </div>
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
                <select class="symbol-select" id="symbolSelect" onchange="changeSymbol()">
                    <option value="GBP_USD">GBP/USD</option>
                    <option value="EUR_USD">EUR/USD</option>
                    <option value="USD_JPY">USD/JPY</option>
                    <option value="USD_CHF">USD/CHF</option>
                    <option value="AUD_USD">AUD/USD</option>
                    <option value="USD_CAD">USD/CAD</option>
                    <option value="EUR_GBP">EUR/GBP</option>
                    <option value="EUR_JPY">EUR/JPY</option>
                    <option value="GBP_JPY">GBP/JPY</option>
                    <option value="XAUUSD">XAU/USD</option>
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="SOLUSDT">SOL/USDT</option>
                </select>
                <select class="symbol-select" id="timeframeSelect" onchange="changeTimeframe()">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h" selected>1 Hour</option>
                    <option value="4h">4 Hours</option>
                    <option value="1d">1 Day</option>
                    <option value="1wk">1 Week</option>
                    <option value="1mo">1 Month</option>
                </select>
            </div>
            
            <!-- Chart Toolbar -->
            <div class="chart-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="btnTrendline" onclick="setDrawingMode('trendline')" title="Trendline">
                        <i class="fas fa-slash"></i> Trendline
                    </button>
                    <button class="toolbar-btn" id="btnHLine" onclick="setDrawingMode('hline')" title="Horizontal Line">
                        <i class="fas fa-minus"></i> H-Line
                    </button>
                    <button class="toolbar-btn" id="btnRectangle" onclick="setDrawingMode('rectangle')" title="Rectangle">
                        <i class="far fa-square"></i> Rectangle
                    </button>
                    <button class="toolbar-btn" id="btnFibonacci" onclick="setDrawingMode('fibonacci')" title="Fibonacci">
                        <i class="fas fa-wave-square"></i> Fibonacci
                    </button>
                    <button class="toolbar-btn" onclick="clearDrawings()" title="Clear All">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                
                <select class="indicator-select" id="indicatorSelect" onchange="changeIndicator()">
                    <option value="">-- Indicators --</option>
                    <option value="EMA">EMA</option>
                    <option value="SMA">SMA</option>
                    <option value="RSI">RSI</option>
                    <option value="BB">Bollinger Bands</option>
                </select>
                
                <div class="indicator-settings" id="indicatorSettings" style="display:none;">
                    <label>Period:</label>
                    <input type="number" id="indicatorPeriod" value="14" min="1" max="200" onchange="updateIndicator()">
                    <label>Color:</label>
                    <input type="color" id="indicatorColor" class="indicator-color" value="#f0b429" onchange="updateIndicator()">
                    <button class="toolbar-btn" onclick="removeIndicator()" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div id="chart"></div>
            <div id="rsiChart"></div>
        </div>
        
        <!-- Info Cards -->
        <div class="info-grid">
            <!-- Bot Info -->
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-card-icon bot"><i class="fas fa-robot"></i></div>
                    <div>
                        <h3>CHIBOY BOT</h3>
                        <div class="subtitle">ICT Trading System</div>
                    </div>
                </div>
                <p>A professional forex and crypto trading bot based on the ICT (Inner Circle Trader) methodology. Features real-time market analysis, order block detection, liquidity sweep identification, and automated trading signals.</p>
                <div class="features">
                    <span class="feature-tag">Order Blocks</span>
                    <span class="feature-tag">Liquidity Sweeps</span>
                    <span class="feature-tag">FVG Detection</span>
                    <span class="feature-tag">Market Structure</span>
                    <span class="feature-tag">1:3 R:R</span>
                </div>
            </div>
            
            <!-- Author Info -->
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-card-icon author"><i class="fas fa-building"></i></div>
                    <div>
                        <h3>Chiboy Technologies</h3>
                        <div class="subtitle">ICT Trading Solutions</div>
                    </div>
                </div>
                <p>Building professional trading tools with advanced ICT concepts. Chiboy Technologies combines cutting-edge technology with proven trading methodologies to deliver powerful analysis tools for traders worldwide.</p>
                <div class="social-links">
                    <a href="https://github.com/xplorer101/chiboy-bot" class="social-link" target="_blank"><i class="fab fa-github"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-discord"></i></a>
                </div>
            </div>
            
            <!-- GitHub Info -->
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-card-icon github"><i class="fab fa-github"></i></div>
                    <div>
                        <h3>Open Source</h3>
                        <div class="subtitle">Contribute & Learn</div>
                    </div>
                </div>
                <p>CHIBOY BOT is open source! Fork the repository, contribute improvements, or learn from the code. Built with Flask, Python, and JavaScript.</p>
                <div class="features">
                    <span class="feature-tag">Python</span>
                    <span class="feature-tag">Flask</span>
                    <span class="feature-tag">JavaScript</span>
                    <span class="feature-tag">Lightweight Charts</span>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Â© 2026 CHIBOY BOT â€¢ Built with <i class="fas fa-heart" style="color:var(--accent-red)"></i> using ICT Strategy</p>
            <p><a href="https://github.com/xplorer101/chiboy-bot">GitHub</a> â€¢ <a href="/opportunities">Opportunities</a> â€¢ <a href="/analysis">Analysis</a></p>
        </div>
    </div>

    <script>
        let chart, candlestickSeries, rsiChart, rsiSeries;
        let currentSymbol = 'GBP_USD';
        let currentTimeframe = '1h';
        
        // Indicator state
        let currentIndicator = null;
        let indicatorSeries = null;
        let indicatorData = [];
        
        // Drawing state
        let drawingMode = null;
        let isDrawing = false;
        let drawStartPoint = null;
        let drawings = [];
        let drawingsMap = new Map();
        let lineIdCounter = 0;
        
        // Fibonacci levels
        const FIB_LEVELS = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1];
        const FIB_COLORS = ['#f85149', '#f0b429', '#58a6ff', '#a371f7', '#3fb950', '#39d0d6', '#f85149'];
        
        // Load drawings from localStorage
        function loadDrawings() {
            try {
                const saved = localStorage.getItem('chiboy_drawings_' + currentSymbol);
                if (saved) {
                    drawings = JSON.parse(saved);
                    drawings.forEach(d => {
                        drawStoredLine(d);
                    });
                }
            } catch (e) { console.error('Error loading drawings:', e); }
        }
        
        // Save drawings to localStorage
        function saveDrawings() {
            try {
                localStorage.setItem('chiboy_drawings_' + currentSymbol, JSON.stringify(drawings));
            } catch (e) { console.error('Error saving drawings:', e); }
        }
        
        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('open');
        }
        
        function formatPrice(price, symbol) {
            if (symbol === 'XAUUSD' || symbol === 'BTCUSDT' || symbol === 'ETHUSDT' || symbol === 'SOLUSDT') {
                return price.toFixed(2);
            } else if (symbol?.includes('JPY')) {
                return price.toFixed(3);
            }
            return price.toFixed(5);
        }
        
        function getTimeframeInterval(tf) {
            const map = {
                '1m': '1m', '5m': '5m', '15m': '15m', '1h': '1h',
                '4h': '4h', '1d': '1d', '1wk': '1wk', '1mo': '1mo'
            };
            return map[tf] || '1h';
        }
        
        // Force 5 decimal places for forex on chart
        function getChartDecimals(symbol) {
            if (symbol && (symbol.includes('JPY'))) return 3;
            return 5;
        }
        
        function initChart() {
            chart = LightweightCharts.createChart(document.getElementById('chart'), {
                layout: { background: { type: 'solid', color: '#161b22' }, textColor: '#8b949e' },
                grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                timeScale: { borderColor: '#30363d' },
                rightPriceScale: { 
                    borderColor: '#30363d',
                    scaleMargins: { top: 0.1, bottom: 0.2 }
                }
            });
            
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#3fb950', downColor: '#f85149',
                borderUpColor: '#3fb950', borderDownColor: '#f85149',
                wickUpColor: '#3fb950', wickDownColor: '#f85149'
            });
            
            // Init RSI chart (hidden by default)
            rsiChart = LightweightCharts.createChart(document.getElementById('rsiChart'), {
                layout: { background: { type: 'solid', color: '#161b22' }, textColor: '#8b949e' },
                grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } },
                timeScale: { borderColor: '#30363d', visible: false },
                rightPriceScale: { 
                    borderColor: '#30363d',
                    scaleMargins: { top: 0.1, bottom: 0.1 }
                },
                height: 120
            });
            
            rsiSeries = rsiChart.addLineSeries({
                color: '#f0b429',
                lineWidth: 2,
                priceFormat: { type: 'custom', formatter: function(p) { return p.toFixed(1); } }
            });
            
            // Subscribe to crosshair move for price tracking
            chart.subscribeCrosshairMove(function(param) {
                if (param.time && param.seriesData.get(candlestickSeries)) {
                    const candleData = param.seriesData.get(candlestickSeries);
                    document.getElementById('priceMain').textContent = formatPrice(candleData.close, currentSymbol);
                }
            });
            
            // Subscribe to click for drawing
            chart.subscribeClick(function(param) {
                handleChartClick(param);
            });
            
            loadChartData();
            loadDrawings();
        }
        
        // ===== INDICATOR CALCULATIONS =====
        
        function calculateEMA(data, period) {
            const ema = [];
            const multiplier = 2 / (period + 1);
            
            // Calculate initial SMA
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += data[i].close;
            }
            let prevEma = sum / period;
            
            ema.push({ time: data[period - 1].time, value: prevEma });
            
            for (let i = period; i < data.length; i++) {
                const currentEma = (data[i].close - prevEma) * multiplier + prevEma;
                ema.push({ time: data[i].time, value: currentEma });
                prevEma = currentEma;
            }
            
            return ema;
        }
        
        function calculateSMA(data, period) {
            const sma = [];
            
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                sma.push({ time: data[i].time, value: sum / period });
            }
            
            return sma;
        }
        
        function calculateRSI(data, period) {
            const rsi = [];
            let gains = [];
            let losses = [];
            
            // Calculate price changes
            for (let i = 1; i < data.length; i++) {
                const change = data[i].close - data[i - 1].close;
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? Math.abs(change) : 0);
            }
            
            // Calculate initial averages
            let avgGain = 0, avgLoss = 0;
            for (let i = 0; i < period; i++) {
                avgGain += gains[i];
                avgLoss += losses[i];
            }
            avgGain /= period;
            avgLoss /= period;
            
            // First RSI value
            let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
            let rsiValue = 100 - (100 / (1 + rs));
            rsi.push({ time: data[period].time, value: rsiValue });
            
            // Subsequent RSI values (smoothed)
            for (let i = period; i < gains.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                rsiValue = 100 - (100 / (1 + rs));
                rsi.push({ time: data[i + 1].time, value: rsiValue });
            }
            
            return rsi;
        }
        
        function calculateBollingerBands(data, period, stdDevMult) {
            const bb = { upper: [], middle: [], lower: [] };
            
            // Calculate middle band (SMA)
            const sma = calculateSMA(data, period);
            
            // Calculate standard deviation and bands
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += Math.pow(data[i - j].close - sma[i - period + 1].value, 2);
                }
                const stdDev = Math.sqrt(sum / period);
                const time = data[i].time;
                
                bb.middle.push({ time: time, value: sma[i - period + 1].value });
                bb.upper.push({ time: time, value: sma[i - period + 1].value + stdDevMult * stdDev });
                bb.lower.push({ time: time, value: sma[i - period + 1].value - stdDevMult * stdDev });
            }
            
            return bb;
        }
        
        function changeIndicator() {
            const indicator = document.getElementById('indicatorSelect').value;
            const settingsDiv = document.getElementById('indicatorSettings');
            
            // Remove existing indicator
            if (indicatorSeries) {
                chart.removeSeries(indicatorSeries);
                indicatorSeries = null;
            }
            rsiSeries.setData([]);
            document.getElementById('rsiChart').style.display = 'none';
            
            if (!indicator) {
                currentIndicator = null;
                settingsDiv.style.display = 'none';
                chart.applyOptions({ rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.2 } } });
                return;
            }
            
            currentIndicator = indicator;
            settingsDiv.style.display = 'flex';
            
            // Adjust chart for RSI if needed
            if (indicator === 'RSI') {
                chart.applyOptions({ rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.45 } } });
                document.getElementById('rsiChart').style.display = 'block';
            } else {
                chart.applyOptions({ rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.2 } } });
            }
            
            updateIndicator();
        }
        
        function updateIndicator() {
            if (!currentIndicator || !indicatorData.length) return;
            
            const period = parseInt(document.getElementById('indicatorPeriod').value) || 14;
            const color = document.getElementById('indicatorColor').value;
            
            // Remove existing
            if (indicatorSeries) {
                chart.removeSeries(indicatorSeries);
            }
            
            let indicatorValues = [];
            
            if (currentIndicator === 'EMA') {
                indicatorValues = calculateEMA(indicatorData, period);
                indicatorSeries = chart.addLineSeries({
                    color: color,
                    lineWidth: 2,
                    priceLineVisible: false
                });
                indicatorSeries.setData(indicatorValues);
            } 
            else if (currentIndicator === 'SMA') {
                indicatorValues = calculateSMA(indicatorData, period);
                indicatorSeries = chart.addLineSeries({
                    color: color,
                    lineWidth: 2,
                    priceLineVisible: false
                });
                indicatorSeries.setData(indicatorValues);
            }
            else if (currentIndicator === 'RSI') {
                indicatorValues = calculateRSI(indicatorData, period);
                rsiSeries.setData(indicatorValues);
                rsiSeries.applyOptions({ color: color });
                
                // Add overbought/oversold lines
                rsiChart.addLineSeries({ color: '#f8514966', lineWidth: 1 }).setData(
                    indicatorValues.map(v => ({ time: v.time, value: 70 }))
                );
                rsiChart.addLineSeries({ color: '#3fb95066', lineWidth: 1 }).setData(
                    indicatorValues.map(v => ({ time: v.time, value: 30 }))
                );
            }
            else if (currentIndicator === 'BB') {
                const bb = calculateBollingerBands(indicatorData, period, 2);
                
                // Middle band
                indicatorSeries = chart.addLineSeries({
                    color: color,
                    lineWidth: 1,
                    priceLineVisible: false
                });
                indicatorSeries.setData(bb.middle);
                
                // Upper band
                chart.addLineSeries({ color: color + '88', lineWidth: 1, priceLineVisible: false }).setData(bb.upper);
                // Lower band
                chart.addLineSeries({ color: color + '88', lineWidth: 1, priceLineVisible: false }).setData(bb.lower);
                
                indicatorValues = bb.middle;
            }
        }
        
        function removeIndicator() {
            document.getElementById('indicatorSelect').value = '';
            changeIndicator();
        }
        
        // ===== DRAWING TOOLS =====
        
        function setDrawingMode(mode) {
            // Clear previous active button
            document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
            
            if (drawingMode === mode) {
                // Toggle off
                drawingMode = null;
                isDrawing = false;
                drawStartPoint = null;
                return;
            }
            
            drawingMode = mode;
            
            // Highlight button
            const btnMap = { 'trendline': 'btnTrendline', 'hline': 'btnHLine', 'rectangle': 'btnRectangle', 'fibonacci': 'btnFibonacci' };
            const btnId = btnMap[mode];
            if (btnId) document.getElementById(btnId).classList.add('active');
            
            isDrawing = false;
            drawStartPoint = null;
        }
        
        function handleChartClick(param) {
            if (!drawingMode || !param.time || !param.point) return;
            
            const price = candlestickSeries.coordinateToPrice(param.point.y);
            const time = param.time;
            
            if (drawingMode === 'hline') {
                // Horizontal line - single click
                createHorizontalLine(time, price);
            }
            else if (drawingMode === 'trendline' || drawingMode === 'rectangle') {
                if (!isDrawing) {
                    // Start drawing
                    isDrawing = true;
                    drawStartPoint = { time, price, y: param.point.y };
                } else {
                    // Finish drawing
                    isDrawing = false;
                    if (drawingMode === 'trendline') {
                        createTrendline(drawStartPoint, { time, price });
                    } else if (drawingMode === 'rectangle') {
                        createRectangle(drawStartPoint, { time, price });
                    }
                    drawStartPoint = null;
                }
            }
            else if (drawingMode === 'fibonacci') {
                // Fibonacci - find high/low in visible range
                createFibonacci(time, price);
            }
        }
        
        function createHorizontalLine(time, price) {
            const id = 'hline_' + (++lineIdCounter);
            const line = chart.addLineSeries({
                color: '#f0b429',
                lineWidth: 1,
                lineStyle: 2, // Dashed
                priceLineVisible: false,
                lastValueVisible: true,
                title: 'H-Line'
            });
            line.setData([{ time: time, value: price }, { time: '2030-12-31', value: price }]);
            
            drawingsMap.set(id, line);
            drawings.push({ id, type: 'hline', price });
            saveDrawings();
        }
        
        function createTrendline(start, end) {
            const id = 'trendline_' + (++lineIdCounter);
            const line = chart.addLineSeries({
                color: '#58a6ff',
                lineWidth: 2,
                priceLineVisible: false
            });
            line.setData([{ time: start.time, value: start.price }, { time: end.time, value: end.price }]);
            
            drawingsMap.set(id, line);
            drawings.push({ 
                id, 
                type: 'trendline', 
                startTime: start.time, 
                startPrice: start.price, 
                endTime: end.time, 
                endPrice: end.price 
            });
            saveDrawings();
        }
        
        function createRectangle(start, end) {
            const id = 'rect_' + (++lineIdCounter);
            
            // Create top and bottom lines
            const topPrice = Math.max(start.price, end.price);
            const bottomPrice = Math.min(start.price, end.price);
            
            const rect = {
                id,
                type: 'rectangle',
                topLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false }),
                bottomLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false }),
                leftLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false }),
                rightLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false })
            };
            
            rect.topLine.setData([
                { time: start.time, value: topPrice },
                { time: end.time, value: topPrice }
            ]);
            rect.bottomLine.setData([
                { time: start.time, value: bottomPrice },
                { time: end.time, value: bottomPrice }
            ]);
            rect.leftLine.setData([
                { time: start.time, value: topPrice },
                { time: start.time, value: bottomPrice }
            ]);
            rect.rightLine.setData([
                { time: end.time, value: topPrice },
                { time: end.time, value: bottomPrice }
            ]);
            
            drawingsMap.set(id, rect);
            drawings.push({ 
                id, 
                type: 'rectangle', 
                startTime: start.time, 
                endTime: end.time,
                topPrice, 
                bottomPrice 
            });
            saveDrawings();
        }
        
        function createFibonacci(time, currentPrice) {
            // Get visible data range
            const visibleRange = chart.timeScale().getVisibleRange();
            if (!visibleRange) return;
            
            // Find high and low in visible range
            let high = -Infinity, low = Infinity;
            
            indicatorData.forEach(candle => {
                if (candle.time >= visibleRange.from && candle.time <= visibleRange.to) {
                    high = Math.max(high, candle.high);
                    low = Math.min(low, candle.low);
                }
            });
            
            if (high === -Infinity || low === Infinity) return;
            
            const id = 'fib_' + (++lineIdCounter);
            const fibLines = [];
            
            FIB_LEVELS.forEach((level, i) => {
                const price = high - (high - low) * level;
                const line = chart.addLineSeries({
                    color: FIB_COLORS[i],
                    lineWidth: 1,
                    lineStyle: level === 0 || level === 1 ? 0 : 2,
                    priceLineVisible: true,
                    lastValueVisible: false,
                    title: 'Fib ' + (level * 100).toFixed(1) + '%'
                });
                
                const startTime = visibleRange.from;
                const endTime = visibleRange.to;
                
                line.setData([
                    { time: startTime, value: price },
                    { time: endTime, value: price }
                ]);
                
                fibLines.push(line);
            });
            
            drawingsMap.set(id, fibLines);
            drawings.push({ 
                id, 
                type: 'fibonacci', 
                high, 
                low,
                startTime: visibleRange.from,
                endTime: visibleRange.to
            });
            saveDrawings();
        }
        
        function drawStoredLine(drawing) {
            // Recreate drawings from storage
            if (drawing.type === 'hline') {
                const line = chart.addLineSeries({
                    color: '#f0b429',
                    lineWidth: 1,
                    lineStyle: 2,
                    priceLineVisible: false,
                    lastValueVisible: true
                });
                line.setData([{ time: drawing.startTime || '2024-01-01', value: drawing.price }, { time: '2030-12-31', value: drawing.price }]);
                drawingsMap.set(drawing.id, line);
                lineIdCounter = Math.max(lineIdCounter, parseInt(drawing.id.split('_')[1] || 0));
            }
            else if (drawing.type === 'trendline') {
                const line = chart.addLineSeries({
                    color: '#58a6ff',
                    lineWidth: 2,
                    priceLineVisible: false
                });
                line.setData([
                    { time: drawing.startTime, value: drawing.startPrice },
                    { time: drawing.endTime, value: drawing.endPrice }
                ]);
                drawingsMap.set(drawing.id, line);
                lineIdCounter = Math.max(lineIdCounter, parseInt(drawing.id.split('_')[1] || 0));
            }
            else if (drawing.type === 'rectangle') {
                const rect = {
                    topLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false }),
                    bottomLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false }),
                    leftLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false }),
                    rightLine: chart.addLineSeries({ color: '#a371f7', lineWidth: 1, priceLineVisible: false })
                };
                
                rect.topLine.setData([
                    { time: drawing.startTime, value: drawing.topPrice },
                    { time: drawing.endTime, value: drawing.topPrice }
                ]);
                rect.bottomLine.setData([
                    { time: drawing.startTime, value: drawing.bottomPrice },
                    { time: drawing.endTime, value: drawing.bottomPrice }
                ]);
                rect.leftLine.setData([
                    { time: drawing.startTime, value: drawing.topPrice },
                    { time: drawing.startTime, value: drawing.bottomPrice }
                ]);
                rect.rightLine.setData([
                    { time: drawing.endTime, value: drawing.topPrice },
                    { time: drawing.endTime, value: drawing.bottomPrice }
                ]);
                
                drawingsMap.set(drawing.id, rect);
                lineIdCounter = Math.max(lineIdCounter, parseInt(drawing.id.split('_')[1] || 0));
            }
            else if (drawing.type === 'fibonacci') {
                const fibLines = [];
                FIB_LEVELS.forEach((level, i) => {
                    const price = drawing.high - (drawing.high - drawing.low) * level;
                    const line = chart.addLineSeries({
                        color: FIB_COLORS[i],
                        lineWidth: 1,
                        lineStyle: level === 0 || level === 1 ? 0 : 2,
                        priceLineVisible: true,
                        lastValueVisible: false
                    });
                    line.setData([
                        { time: drawing.startTime, value: price },
                        { time: drawing.endTime, value: price }
                    ]);
                    fibLines.push(line);
                });
                drawingsMap.set(drawing.id, fibLines);
                lineIdCounter = Math.max(lineIdCounter, parseInt(drawing.id.split('_')[1] || 0));
            }
        }
        
        function clearDrawings() {
            // Remove all drawings from chart
            drawings.forEach(d => {
                const obj = drawingsMap.get(d.id);
                if (obj) {
                    if (Array.isArray(obj)) {
                        obj.forEach(line => chart.removeSeries(line));
                    } else if (obj.topLine) {
                        // Rectangle
                        chart.removeSeries(obj.topLine);
                        chart.removeSeries(obj.bottomLine);
                        chart.removeSeries(obj.leftLine);
                        chart.removeSeries(obj.rightLine);
                    } else {
                        chart.removeSeries(obj);
                    }
                }
            });
            
            drawings = [];
            drawingsMap.clear();
            saveDrawings();
            
            // Reset drawing mode
            drawingMode = null;
            isDrawing = false;
            drawStartPoint = null;
            document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
        }
        
        async function loadChartData() {
            try {
                const interval = getTimeframeInterval(currentTimeframe);
                const response = await fetch('/api/chart/' + currentSymbol + '?timeframe=' + interval);
                const data = await response.json();
                
                if (data.candles) {
                    candlestickSeries.setData(data.candles);
                    indicatorData = data.candles;
                    
                    if (data.candles.length > 0) {
                        const last = data.candles[data.candles.length - 1];
                        document.getElementById('priceMain').textContent = formatPrice(last.close, currentSymbol);
                        
                        const prev = data.candles[data.candles.length - 2];
                        const change = prev ? ((last.close - prev.close) / prev.close * 100).toFixed(2) : '0.00';
                        const changeEl = document.getElementById('priceChange');
                        changeEl.textContent = (change >= 0 ? '+' : '') + change + '%';
                        changeEl.className = 'price-change ' + (change >= 0 ? 'up' : 'down');
                    }
                    
                    // Reapply indicator if active
                    if (currentIndicator) {
                        updateIndicator();
                    }
                    
                    // Reload drawings for new symbol
                    drawings = [];
                    drawingsMap.clear();
                    loadDrawings();
                }
            } catch (e) { console.error('Error loading chart:', e); }
        }
        
        function changeSymbol() {
            currentSymbol = document.getElementById('symbolSelect').value;
            // Update chart price format on series
            candlestickSeries.applyOptions({
                priceFormat: {
                    type: 'custom',
                    formatter: function(price) { return price.toFixed(5); }
                }
            });
            loadChartData();
        }
        
        function changeTimeframe() {
            currentTimeframe = document.getElementById('timeframeSelect').value;
            loadChartData();
        }
        
        setInterval(loadChartData, 30000);
        
        // Handle window resize
        window.addEventListener('resize', function() {
            chart.resize(document.getElementById('chart').clientWidth, document.getElementById('chart').clientHeight);
            rsiChart.resize(document.getElementById('rsiChart').clientWidth, 120);
        });
        
        initChart();
    </script>
    <script>
        // Theme Toggle Functionality
        function toggleTheme() {
            const body = document.body;
            const icon = document.querySelector('.theme-toggle i');
            
            body.classList.toggle('light-theme');
            
            // Save preference to localStorage
            const isLight = body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            
            // Update icon
            if (isLight) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
            
            // Update chart colors
            updateChartTheme(isLight);
        }
        
        // Update chart theme colors
        function updateChartTheme(isLight) {
            const bgColor = isLight ? '#ffffff' : '#161b22';
            const textColor = isLight ? '#59636e' : '#8b949e';
            const gridColor = isLight ? '#d0d7de' : '#30363d';
            
            if (chart) {
                chart.applyOptions({
                    layout: { background: { type: 'solid', color: bgColor }, textColor: textColor },
                    grid: { vertLines: { color: gridColor }, horzLines: { color: gridColor } }
                });
            }
            if (rsiChart) {
                rsiChart.applyOptions({
                    layout: { background: { type: 'solid', color: bgColor }, textColor: textColor },
                    grid: { vertLines: { color: gridColor }, horzLines: { color: gridColor } }
                });
            }
        }
        
        // Apply saved theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const icon = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'light') {
                body.classList.add('light-theme');
                if (icon) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
                // Apply chart theme after charts are initialized
                setTimeout(() => updateChartTheme(true), 100);
            }
        })();
    </script>
</body>
</html>
